#!/usr/bin/env python3
"""
Comprehensive Vulnerability Scanner
Orchestrates multiple scanning modules
"""

import argparse
import sys
import os
from typing import Optional

ROOT_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
if ROOT_DIR not in sys.path:
    sys.path.insert(0, ROOT_DIR)

from colorama import Fore, Style, init
import json
from datetime import datetime
from urllib.parse import urlparse
from utils.targets import normalize_url

init(autoreset=True)

class VulnerabilityScanner:
    def __init__(self, target: str, output_dir: str = "./results", *, port_scan_mode: Optional[str] = None,
                 port_scan_ports: Optional[str] = None, port_scan_threads: int = 100):
        self.target = target
        try:
            self.base_url = normalize_url(target)
        except ValueError:
            raise
        self.domain = urlparse(self.base_url).netloc or target
        self.target_slug = self._safe_name(self.base_url)
        self.output_dir = output_dir
        self.port_scan_mode = port_scan_mode
        self.port_scan_ports = port_scan_ports
        self.port_scan_threads = port_scan_threads
        self._seen_signatures = set()
        self.errors = []
        self.results = {
            'target': self.base_url,
            'scan_date': datetime.now().isoformat(),
            'vulnerabilities': [],
            'reconnaissance': {},
            'errors': self.errors,
        }
        
        os.makedirs(output_dir, exist_ok=True)

    def _safe_name(self, name: str) -> str:
        return name.replace("://", "_").replace("/", "_")
    
    def print_banner(self):
        banner = f"""
{Fore.CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                   â•‘
â•‘     Bug Bounty Vulnerability Scanner             â•‘
â•‘     Comprehensive Security Assessment Tool       â•‘
â•‘                                                   â•‘
â•‘     Target: {self.base_url:<36}â•‘
â•‘                                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•{Style.RESET_ALL}

{Fore.YELLOW}[!] LEGAL WARNING:{Style.RESET_ALL}
Only use this tool on targets you have explicit permission to test.
Unauthorized testing is illegal and unethical.

{Fore.CYAN}{'='*55}{Style.RESET_ALL}
        """
        print(banner)
    
    def run_reconnaissance(self):
        """Run reconnaissance phase"""
        print(f"\n{Fore.CYAN}{'='*55}{Style.RESET_ALL}")
        print(f"{Fore.CYAN}Phase 1: Reconnaissance{Style.RESET_ALL}")
        print(f"{Fore.CYAN}{'='*55}{Style.RESET_ALL}\n")
        
        # Import and run subdomain finder
        try:
            from recon.subdomain_finder import SubdomainFinder
            print(f"{Fore.YELLOW}[*] Running subdomain enumeration...{Style.RESET_ALL}")
            finder = SubdomainFinder(self.domain, self.output_dir)
            subdomains = finder.run()
            self.results['reconnaissance']['subdomains'] = list(subdomains)
            print(f"{Fore.GREEN}[+] Found {len(subdomains)} subdomains{Style.RESET_ALL}\n")
        except Exception as e:
            print(f"{Fore.RED}[-] Subdomain enumeration failed: {str(e)}{Style.RESET_ALL}\n")
            self.errors.append(f"Subdomain enumeration error: {e}")
        
        # Import and run technology detection
        try:
            from recon.tech_detector import TechDetector
            print(f"{Fore.YELLOW}[*] Running technology detection...{Style.RESET_ALL}")
            detector = TechDetector(self.base_url, self.output_dir)
            detector.run()
            self.results['reconnaissance']['technologies'] = detector.technologies
            print(f"{Fore.GREEN}[+] Technology detection complete{Style.RESET_ALL}\n")
        except Exception as e:
            print(f"{Fore.RED}[-] Technology detection failed: {str(e)}{Style.RESET_ALL}\n")
            self.errors.append(f"Technology detection error: {e}")

        # Run port scanning if requested
        if self.port_scan_mode:
            try:
                from recon.port_scanner import PortScanner
                print(f"{Fore.YELLOW}[*] Running port scan ({self.port_scan_mode})...{Style.RESET_ALL}")
                port_scanner = PortScanner(self.domain, self.output_dir)

                if self.port_scan_mode == "quick":
                    port_scanner.quick_scan(threads=self.port_scan_threads)
                elif self.port_scan_mode == "full":
                    port_scanner.full_scan(threads=self.port_scan_threads)
                elif self.port_scan_mode == "custom":
                    port_range = self.port_scan_ports or "1-1024"
                    port_scanner.custom_scan(port_range, threads=self.port_scan_threads)
                else:
                    raise ValueError(f"Unknown port scan mode: {self.port_scan_mode}")

                port_scanner.print_summary()
                port_scanner.save_results()

                self.results['reconnaissance']['ports'] = {
                    'total_open_ports': len(port_scanner.open_ports),
                    'open_ports': [
                        {'port': port, 'service': service}
                        for port, service in sorted(port_scanner.open_ports.items())
                    ]
                }
                print(f"{Fore.GREEN}[+] Port scan complete{Style.RESET_ALL}\n")
            except Exception as e:
                print(f"{Fore.RED}[-] Port scan failed: {str(e)}{Style.RESET_ALL}\n")
                self.errors.append(f"Port scan error: {e}")
    
    def run_vulnerability_scans(self):
        """Run vulnerability scanning phase"""
        print(f"\n{Fore.CYAN}{'='*55}{Style.RESET_ALL}")
        print(f"{Fore.CYAN}Phase 2: Vulnerability Scanning{Style.RESET_ALL}")
        print(f"{Fore.CYAN}{'='*55}{Style.RESET_ALL}\n")
        
        target_url = self.base_url
        
        # XSS Scan
        try:
            from scanners.xss_scanner import XSSScanner
            print(f"{Fore.YELLOW}[*] Running XSS scan...{Style.RESET_ALL}")
            xss_scanner = XSSScanner(target_url, self.output_dir)
            xss_scanner.run()
            self._add_vulnerabilities(xss_scanner.vulnerabilities, "XSS")
            print(f"{Fore.GREEN}[+] XSS scan complete{Style.RESET_ALL}\n")
        except Exception as e:
            print(f"{Fore.RED}[-] XSS scan failed: {str(e)}{Style.RESET_ALL}\n")
            self.errors.append(f"XSS scan error: {e}")
        
        # SQL Injection Scan
        try:
            from scanners.sqli_scanner import SQLiScanner
            print(f"{Fore.YELLOW}[*] Running SQL injection scan...{Style.RESET_ALL}")
            sqli_scanner = SQLiScanner(target_url, self.output_dir)
            sqli_scanner.run()
            self._add_vulnerabilities(sqli_scanner.vulnerabilities, "SQLi")
            print(f"{Fore.GREEN}[+] SQL injection scan complete{Style.RESET_ALL}\n")
        except Exception as e:
            print(f"{Fore.RED}[-] SQL injection scan failed: {str(e)}{Style.RESET_ALL}\n")
            self.errors.append(f"SQLi scan error: {e}")
        
        # Directory Scan
        try:
            from scanners.directory_scanner import DirectoryScanner
            print(f"{Fore.YELLOW}[*] Running directory scan...{Style.RESET_ALL}")
            dir_scanner = DirectoryScanner(target_url, self.output_dir)
            dir_scanner.run()
            self.results['reconnaissance']['directories'] = dir_scanner.found_paths
            print(f"{Fore.GREEN}[+] Directory scan complete{Style.RESET_ALL}\n")
        except Exception as e:
            print(f"{Fore.RED}[-] Directory scan failed: {str(e)}{Style.RESET_ALL}\n")
            self.errors.append(f"Directory scan error: {e}")

    def _add_vulnerabilities(self, vulns, source):
        """Deduplicate and annotate vulnerabilities from scanners."""
        for vuln in vulns:
            signature = (
                vuln.get('type'),
                vuln.get('url'),
                vuln.get('parameter'),
                vuln.get('payload'),
            )
            if signature in self._seen_signatures:
                continue
            vuln.setdefault('source', source)
            self._seen_signatures.add(signature)
            self.results['vulnerabilities'].append(vuln)
    
    def generate_report(self):
        """Generate comprehensive report"""
        print(f"\n{Fore.CYAN}{'='*55}{Style.RESET_ALL}")
        print(f"{Fore.CYAN}Scan Summary{Style.RESET_ALL}")
        print(f"{Fore.CYAN}{'='*55}{Style.RESET_ALL}\n")
        
        # Count vulnerabilities by severity
        critical = sum(1 for v in self.results['vulnerabilities'] if v.get('severity') == 'Critical')
        high = sum(1 for v in self.results['vulnerabilities'] if v.get('severity') == 'High')
        medium = sum(1 for v in self.results['vulnerabilities'] if v.get('severity') == 'Medium')
        low = sum(1 for v in self.results['vulnerabilities'] if v.get('severity') == 'Low')
        
        print(f"{Fore.YELLOW}Total Vulnerabilities Found: {len(self.results['vulnerabilities'])}{Style.RESET_ALL}")
        if critical > 0:
            print(f"{Fore.RED}  - Critical: {critical}{Style.RESET_ALL}")
        if high > 0:
            print(f"{Fore.RED}  - High: {high}{Style.RESET_ALL}")
        if medium > 0:
            print(f"{Fore.YELLOW}  - Medium: {medium}{Style.RESET_ALL}")
        if low > 0:
            print(f"{Fore.GREEN}  - Low: {low}{Style.RESET_ALL}")
        
        print(f"\n{Fore.CYAN}Reconnaissance Results:{Style.RESET_ALL}")
        if 'subdomains' in self.results['reconnaissance']:
            print(f"  - Subdomains: {len(self.results['reconnaissance']['subdomains'])}")
        if 'directories' in self.results['reconnaissance']:
            print(f"  - Directories/Files: {len(self.results['reconnaissance']['directories'])}")
        if 'ports' in self.results['reconnaissance']:
            port_data = self.results['reconnaissance']['ports']
            print(f"  - Open Ports: {port_data.get('total_open_ports', 0)}")
        if self.errors:
            print(f"\n{Fore.YELLOW}Warnings/Errors: {len(self.errors)}{Style.RESET_ALL}")
        
        # Save comprehensive report
        report_file = os.path.join(self.output_dir, f"{self.target_slug}_comprehensive_report.json")
        with open(report_file, 'w') as f:
            json.dump(self.results, f, indent=2)
        
        print(f"\n{Fore.GREEN}[+] Comprehensive report saved to: {report_file}{Style.RESET_ALL}")
        
        # Generate HTML report
        self.generate_html_report()
    
    def generate_html_report(self):
        """Generate HTML report"""
        html_template = f"""
<!DOCTYPE html>
<html>
<head>
    <title>Security Scan Report - {self.base_url}</title>
    <style>
        body {{ font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }}
        .container {{ max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }}
        h1 {{ color: #333; border-bottom: 3px solid #007bff; padding-bottom: 10px; }}
        h2 {{ color: #555; margin-top: 30px; }}
        .critical {{ background: #dc3545; color: white; padding: 10px; border-radius: 4px; margin: 10px 0; }}
        .high {{ background: #fd7e14; color: white; padding: 10px; border-radius: 4px; margin: 10px 0; }}
        .medium {{ background: #ffc107; color: #333; padding: 10px; border-radius: 4px; margin: 10px 0; }}
        .low {{ background: #28a745; color: white; padding: 10px; border-radius: 4px; margin: 10px 0; }}
        .info {{ background: #17a2b8; color: white; padding: 10px; border-radius: 4px; margin: 10px 0; }}
        .vuln-item {{ margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }}
        .stat {{ display: inline-block; margin: 10px 20px 10px 0; padding: 10px 20px; background: #007bff; color: white; border-radius: 4px; }}
        code {{ background: #f4f4f4; padding: 2px 6px; border-radius: 3px; }}
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”’ Security Scan Report</h1>
        <p><strong>Target:</strong> {self.base_url}</p>
        <p><strong>Scan Date:</strong> {self.results['scan_date']}</p>

        <h2>ğŸ“Š Summary</h2>
        <div class="stat">Total Vulnerabilities: {len(self.results['vulnerabilities'])}</div>

        <h2>ğŸ” Reconnaissance</h2>
"""

        recon = self.results.get('reconnaissance', {})
        if recon.get('subdomains'):
            html_template += """
        <h3>Subdomains</h3>
        <p>Discovered: {len(recon.get('subdomains', []))}</p>
"""

        if recon.get('directories'):
            html_template += """
        <h3>Directories/Files</h3>
        <p>Discovered: {len(recon.get('directories', []))}</p>
"""

        if recon.get('ports'):
            port_data = recon['ports']
            html_template += """
        <h3>Open Ports</h3>
        <p>Total Open Ports: {port_data.get('total_open_ports', 0)}</p>
        <ul>
"""
            for port in port_data.get('open_ports', []):
                html_template += f"            <li>Port {port.get('port')} - {port.get('service', 'Unknown')}</li>\n"
            html_template += "        </ul>\n"

        html_template += """
        <h2>ğŸš¨ Vulnerabilities</h2>
"""
        
        for vuln in self.results['vulnerabilities']:
            severity = vuln.get('severity', 'Unknown').lower()
            html_template += f"""
        <div class="vuln-item {severity}">
            <h3>{vuln.get('type', 'Unknown')}</h3>
            <p><strong>URL:</strong> <code>{vuln.get('url', 'N/A')}</code></p>
            <p><strong>Parameter:</strong> <code>{vuln.get('parameter', 'N/A')}</code></p>
            <p><strong>Payload:</strong> <code>{vuln.get('payload', 'N/A')}</code></p>
            <p><strong>Severity:</strong> {vuln.get('severity', 'Unknown')}</p>
        </div>
"""
        if self.errors:
            html_template += """
        <h2>âš ï¸ Scanner Warnings</h2>
        <ul>
"""
            for warning in self.errors:
                html_template += f"            <li>{warning}</li>\n"
            html_template += "        </ul>\n"
        
        html_template += """
    </div>
</body>
</html>
"""
        
        html_file = os.path.join(self.output_dir, f"{self.target_slug}_report.html")
        with open(html_file, 'w') as f:
            f.write(html_template)
        
        print(f"{Fore.GREEN}[+] HTML report saved to: {html_file}{Style.RESET_ALL}")
    
    def run(self, skip_recon: bool = False, skip_vuln: bool = False):
        """Execute full scan"""
        self.print_banner()
        
        if not skip_recon:
            self.run_reconnaissance()
        
        if not skip_vuln:
            self.run_vulnerability_scans()
        
        self.generate_report()
        
        print(f"\n{Fore.CYAN}{'='*55}{Style.RESET_ALL}")
        print(f"{Fore.GREEN}[+] Scan Complete!{Style.RESET_ALL}")
        print(f"{Fore.CYAN}{'='*55}{Style.RESET_ALL}\n")


def main():
    parser = argparse.ArgumentParser(description="Comprehensive Vulnerability Scanner")
    parser.add_argument("-t", "--target", required=True, help="Target domain (e.g., example.com)")
    parser.add_argument("-o", "--output", default="./results", help="Output directory")
    parser.add_argument("--skip-recon", action="store_true", help="Skip reconnaissance phase")
    parser.add_argument("--skip-vuln", action="store_true", help="Skip vulnerability scanning phase")
    parser.add_argument("--port-scan-mode", choices=["quick", "full", "custom"],
                        help="Optional port scan mode to run during reconnaissance")
    parser.add_argument("--port-scan-ports", help="Port range or list for custom port scan (e.g., 1-1024 or 80,443)")
    parser.add_argument("--port-scan-threads", type=int, default=100, help="Threads to use for port scanning")

    args = parser.parse_args()

    scanner = VulnerabilityScanner(
        args.target,
        args.output,
        port_scan_mode=args.port_scan_mode,
        port_scan_ports=args.port_scan_ports,
        port_scan_threads=args.port_scan_threads,
    )
    scanner.run(skip_recon=args.skip_recon, skip_vuln=args.skip_vuln)


if __name__ == "__main__":
    main()
